---
- name: Collect all cli test cases
  find:
    paths: 
      - "{{ role_path }}/tests/cli/merged"
      - "{{ role_path }}/tests/cli/deleted"
      - "{{ role_path }}/tests/cli/overridden"
      - "{{ role_path }}/tests/cli/replaced"
    patterns: "{{ testcase }}.yml"
    use_regex: true
  register: test_cases
  delegate_to: localhost

- block: 
  - name: Setup trustpoint
    ansible.builtin.include_tasks: "{{ role_path }}/tests/cli/_setup_trustpoint.yml"

  - name: Set test_items
    set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"

  - name: Run test cases (connection=network_cli)
    include_tasks:
      file: "{{ test_case_to_run }}"
    vars:
      ansible_connection: ansible.netcommon.network_cli
    with_items: "{{ test_items }}"
    loop_control:
      loop_var: test_case_to_run

  always: 
    - name: Destroy trustpoint
      ansible.builtin.include_tasks: "{{ role_path }}/tests/cli/_destroy_trustpoint.yml"
